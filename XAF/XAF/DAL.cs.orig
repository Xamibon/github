using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data.SqlClient;
using System.Data;
using System.Collections;

namespace XAF
{
    public class DAL
    {
        private SqlParameter _dalStmt;
        private SqlConnection _dalConn;
        private String _dalDBUserName;
        private String _dalDBPassword;
        private String _dalPortNo;
        private String _dalHostName;
        private String _dalDBName;

        public DAL()
        {
            _dalHostName = "Server=(local)";
            _dalDBName = "DataBase=AFX";
            _dalDBUserName = "user=SA";
            _dalDBPassword = "password=VolvoR0x";
            _dalConn = new SqlConnection(_dalHostName + ";" + _dalDBName + ";Integrated Security=SSPI;" + _dalDBUserName + ";" + _dalDBPassword);
        }


        /// <summary>
        /// Saves the supplier.
        /// </summary>
        /// <param name="supp">The supp.</param>

        public void DeleteSupplier(String supplierSE)
        {
            bool isExisting = false;
            try
            {
                SqlCommand cmd = new SqlCommand("sp_DeleteSupplier", _dalConn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@SupplierSE", supplierSE));

                _dalConn.Open();

                int i = cmd.ExecuteNonQuery();

                if (i > 0)
                {
                    isExisting = true;
                }
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
            if (!isExisting)
            {
                throw new Exception("Det angivne leverandør CVR nr eksisterer ikke");
            }
        }

        public void EditSupplier(Supplier supplier)
        {
            try
            {
                SqlCommand cmd = new SqlCommand("sp_EditSupplier", _dalConn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@SupplierSE", supplier.SupplierSE));
                cmd.Parameters.Add(new SqlParameter("@SupplierName", supplier.SupplierName));

                _dalConn.Open();

                cmd.ExecuteReader();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }


        public void SaveSupplier(Supplier supp)
        {
            try
            {
                String supplierName = supp.SupplierName;
                String supplierSE = supp.SupplierSE;
                String queryString = "INSERT INTO Supliers("+supplierName+", "+supplierSE+")";
                SqlCommand cmd = new SqlCommand(queryString, _dalConn);

                _dalConn.Open();

                cmd.ExecuteNonQuery();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
 
        }


        /// <summary>
        /// Saves the user.
        /// </summary>
        /// <param name="user">The user.</param>

        public ArrayList SearchSupplier(String supplierSE)
        {
            bool isExisting = false;
            ArrayList tmpArr = new ArrayList();
            Supplier tmpSupplier;
            try
            {
                SqlCommand cmd = new SqlCommand("sp_SearchSupplier", _dalConn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@SupplierSE", supplierSE));

                _dalConn.Open();

                using (SqlDataReader rdr = cmd.ExecuteReader())
                {
                    while (rdr.Read())
                    {
                        tmpSupplier = new Supplier(rdr.GetString(rdr.GetOrdinal("SupplierSE")),rdr.GetString(rdr.GetOrdinal("SupplierName")));
                        tmpArr.Add(tmpSupplier);
                    }
                    if (tmpArr.Count > 0)
                    {
                        isExisting = true;
                    }
                    rdr.Close();
                }
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
            if (!isExisting)
            {
                throw new Exception("Intet matcher dit søge kriterie");
            }
            return tmpArr;
        }

        public void SaveUser(User user)
        {
            try
            {
                String userFirstName = user.FirstName;
                String userLastName = user.LastName;
                int userID = user.UserID;
                String queryString = "INSERT INTO Users(" + userID + ", " + userFirstName + ", " + userLastName + ")";

                SqlCommand cmd = new SqlCommand(queryString, _dalConn);

                _dalConn.Open();

                cmd.ExecuteNonQuery();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        public void DeleteUser(User user)
        {
            try
            {
                int userID = user.UserID;
                
                SqlCommand cmd = new SqlCommand("spDeleteUser", _dalConn);
                
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@userID", userID));

                _dalConn.Open();

                cmd.ExecuteReader();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        public void EditUser(User user)
        {
            try
            {
                int userID = user.UserID;
                string userFirstName = user.FirstName;
                string userLastName = user.LastName;

                SqlCommand cmd = new SqlCommand("spUpdateUser", _dalConn);

                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@userID", userID));
                cmd.Parameters.Add(new SqlParameter("@firstName", userFirstName));
                cmd.Parameters.Add(new SqlParameter("@lastName", userLastName));

                _dalConn.Open();

                cmd.ExecuteReader();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        public ArrayList SearchUser(String userFirstName, String userLastName)
        {
            ArrayList _arUsers = new ArrayList();

            try
            {
                SqlCommand cmd = new SqlCommand("spSearchUser", _dalConn);

                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@firstName", userFirstName));
                cmd.Parameters.Add(new SqlParameter("@lastName", userLastName));

                _dalConn.Open();

                cmd.ExecuteReader();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        public void DeleteOrder(Order order)
        {
            try
            {
                int orderID = order.OrderID;
                
                SqlCommand cmd = new SqlCommand("spDeleteOrder", _dalConn);
                
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@orderID", orderID));

                _dalConn.Open();

                cmd.ExecuteReader();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        public void EditOrder(int orderID, ArrayList orderItems)
        {
            try
            {
                SqlCommand cmd = new SqlCommand("spUpdateOrder", _dalConn);

                cmd.CommandType = CommandType.StoredProcedure;
                
                int index;
                int iID;
                int oID = orderID;
                    // Loop
                        Item item = orderItems[index];
                        iID = item.ItemID;
                    
                        cmd.Parameters.Add(new SqlParameter("@itemID", itemID));
                        cmd.Parameters.Add(new SqlParameter("@orderID", orderID));

                        _dalConn.Open();

                        cmd.ExecuteReader();
                    // End loop
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        public ArrayList SearchUser(String userFirstName, String userLastName)
        {
            ArrayList _arUsers = new ArrayList();

            try
            {
                SqlCommand cmd = new SqlCommand("spSearchUser", _dalConn);

                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@firstName", userFirstName));
                cmd.Parameters.Add(new SqlParameter("@lastName", userLastName));

                _dalConn.Open();

                cmd.ExecuteReader();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        /// <summary>
        /// Saves the item.
        /// </summary>
        /// <param name="item">The item.</param>
        public void SaveItem(Item item)
        {
            try
            {
                int itemID = item.ItemID;
                String itemName = item.ItemName;
                int itemStock = item.ItemStock;
                String itemSupplier = item.ItemSupplier.SupplierSE;
                decimal itemPrice = item.ItemPrice;
                String itemDescription = item.ItemDescription;
                String queryString = "INSERT INTO Items(" + itemID+ ", " + itemName + ", " + itemStock + ", " + itemPrice + ", " + itemDescription + ", " + itemSupplier + ")";

                SqlCommand cmd = new SqlCommand(queryString, _dalConn);

                _dalConn.Open();

                cmd.ExecuteNonQuery();

            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        /// <summary>
        /// Saves the order.
        /// </summary>
        /// <param name="order">The order.</param>
        public void SaveOrder(Order order)
        {
            try
            {
                int orderID = order.OrderID;
                DateTime orderCreatedDate = order.OrderCreatedDate;
                String orderCreatedBy = order.OrderCreatedBy.FirstName;
                String queryString = "INSERT INTO Orders(" + orderID + ", " + orderCreatedDate + ", " + orderCreatedBy + ")";

                SqlCommand cmd = new SqlCommand(queryString, _dalConn);

                _dalConn.Open();

                cmd.ExecuteNonQuery();
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        /// <summary>
        /// Deletes the item.
        /// </summary>
        /// <param name="itemID">The item ID.</param>
        public void DeleteItem(int itemID)
        {
            bool existing = false;

            try
           
            {                
               
                int tmpItemID = itemID;

                SqlCommand cmd = new SqlCommand("sp_DeleteItem", _dalConn);

                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@ItemID", tmpItemID));

                _dalConn.Open();

                int i = cmd.ExecuteNonQuery();

                if (i > 0)
                {
                    existing = true;
                } 
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
            if (!existing)
            {
                throw new Exception("Item ID eksistere ikke");
            }
        }

        /// <summary>
        /// Edits the item.
        /// </summary>
        /// <param name="item">The item.</param>
        public void EditItem(Item item)
        {
            try
            {

                SqlCommand cmd = new SqlCommand("sp_editItem", _dalConn);
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@itemID", item.ItemID));
                cmd.Parameters.Add(new SqlParameter("@itemID", item.ItemName));
                cmd.Parameters.Add(new SqlParameter("@itemID", item.ItemStock));
                cmd.Parameters.Add(new SqlParameter("@itemID", item.ItemSupplier));
                cmd.Parameters.Add(new SqlParameter("@itemID", item.ItemPrice));
                cmd.Parameters.Add(new SqlParameter("@itemID", item.ItemDescription));

                _dalConn.Open();

                cmd.ExecuteNonQuery();
                
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }
        }

        /// <summary>
        /// Searches the item.
        /// </summary>
        /// <param name="itemID">The item ID.</param>
        /// <returns></returns>
        public ArrayList SearchItem(int itemID)
        {
            ArrayList tmparr = new ArrayList();
            try
            {
                
                Item tmpitem;
                int tmpItemID = itemID;

                SqlCommand cmd = new SqlCommand("sp_searchItem", _dalConn);

                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.Add(new SqlParameter("@ItemID", tmpItemID));

                _dalConn.Open();

                SqlDataReader rdr = cmd.ExecuteReader();

                while (rdr.Read())
                {
                    tmpitem = new Item(rdr.GetInt32(rdr.GetOrdinal("itemID")), 
                                       rdr.GetString(rdr.GetOrdinal("itemName")), 
                                       rdr.GetInt32(rdr.GetOrdinal("itemStock")),
                                       rdr.GetString(rdr.GetOrdinal("suplierSE")), 
                                       rdr.GetDecimal(rdr.GetOrdinal("itemPrice")), 
                                       rdr.GetString(rdr.GetOrdinal("itemDescription")));

                    tmparr.Add(tmpitem);
                }

                rdr.Close();
     
                
            }
            catch (SqlException se)
            {
                throw se;
            }
            catch (FormatException fe)
            {
                throw fe;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                _dalConn.Close();
            }

            return tmparr;
        }

    }
}